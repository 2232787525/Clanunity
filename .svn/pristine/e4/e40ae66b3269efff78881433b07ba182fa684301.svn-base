//
//  CULoginVC.swift
//  Clanunity
//
//  Created by 白bex on 2018/2/1.
//  Copyright © 2018年 DlmTechnology. All rights reserved.
//
import UIKit
import MBProgressHUD
import MJRefresh

//MARK: - ----------------发布动态
class AncestorsInfo: CommentTabVC {
    /// 聊天室model
    var infoView : UITextView!
    var model : AncestorsModel?
    var pinlun = UIButton()
    
    //MARK: - 加载页面 绘制UI
    override func viewDidLoad() {
        super.viewDidLoad()
        self.infoId = self.model?.id

        self.knavigationBar?.title = "详情"
        self.knavigationBar?.rightBarBtnItem = KNaviBarBtnItem.init(frame:  CGRect.init(x: 0, y: KStatusBarHeight, width: 44, height: 44), image: "share_white", hander: {  [weak self](sender) in
            self?.toShare()
        })
    }
    
    //TODO:加载表和详情
    override func maketableView() -> Void {
        super.maketableView()
        
        self.infoView = UITextView.init(frame: CGRect.init(x: 0, y: 0, width: KScreenWidth, height: KScreenHeight - KTopHeight))
        GlobalClass.customProgressHUD(view: self.view)
        
        self.infoView.isUserInteractionEnabled = false
        //子线程 – Swift
        DispatchQueue.global().async {
            
            //加载html富文本
            let htmlString = "<html> \n<head> \n<style type=\"text/css\"> \nbody {padding:0 20px;font-size: 20.0;}\n</style> \n</head> \n<body>" + (self.model?.context)! + "</body> \n</html>"
            do {
                let attrString = try NSMutableAttributedString.init(data: (htmlString.data(using: String.Encoding.unicode))!, options: [NSDocumentTypeDocumentAttribute: NSHTMLTextDocumentType], documentAttributes: nil)
                // 主线程 – Swift
                DispatchQueue.main.async {
                    MBProgressHUD.hideAllHUDs(for: self.view, animated: true)
                    self.infoView.attributedText = attrString;
                    self.infoView.height_sd = self.infoView.contentSize.height
                    self.tableView.tableHeaderView = self.infoView
                }

                DispatchQueue.main.asyncAfter(deadline: .now() + 1) {
                    DispatchQueue.main.async {
                        self.infoView.height_sd = self.infoView.contentSize.height
                        self.tableView.tableHeaderView = self.infoView
                    }
                }
            }catch{
            }
        }

        self.tableView.height_sd = KScreenHeight - KTopHeight - F_I6(place: 49)
        self.tableView.tableHeaderView = self.infoView
        

        pinlun = UIButton.init(frame: CGRect.init(x: 0, y: KScreenHeight-F_I6(place: 49), width: KScreenWidth, height: F_I6(place: 49)))
        pinlun.setBackgroundImage(UIImage.init(named: "pinglun_bg"), for: .normal)
        pinlun.backgroundColor = UIColor.white
        self.view.addSubview(pinlun)
        
        pinlun.handleEventTouchUpInside {
            self.requestForcomment()
        }
    }
    
    override func emptyShow(show:Bool){
        if show{
            self.tableView.contentInset = UIEdgeInsetsMake(0, 0, 180, 0);
            footerview.height_sd = 180
        }else{
            self.tableView.contentInset = UIEdgeInsetsMake(0, 0, 20, 0);
            footerview.height_sd = 0
        }
    }
    
    // MARK: - 分享
    override func toShare() {
        self.shareTitle = self.model?.title
        self.shareUrl = ClanAPI.H5UserName + ClanAPI.H5Share_zongCi + (self.model?.id ?? "")
        self.shareImgUrl = NSString.formatImageUrl(with: model?.themeimg)
        
        PLShareGlobalView.toShare(sharetype : nil, targetid : (self.model?.id)!,  shareTitle: self.shareTitle, shareUrl: self.shareUrl, shareImgUrl: self.shareImgUrl, shareDes: "来自同宗汇", shareimg: nil)
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
    }
}

